CREATE DATABASE AGENDAR;
USE AGENDAR;

DROP TABLE IF EXISTS COMERCIO;
CREATE TABLE COMERCIO (
  ID_COMERCIO INT PRIMARY KEY,
  CNPJ CHAR (14) UNIQUE,
  NOME_COMERCIO VARCHAR (75) NOT NULL,
  EMAIL_COMERCIO VARCHAR (150) NOT NULL UNIQUE,
  SENHA_COMERCIO CHAR (64) NOT NULL,
  ULTIMA_DATA_DOACAO DATE
);

DROP TABLE IF EXISTS USER;
CREATE TABLE USER (
  ID_USER INT AUTO_INCREMENT PRIMARY KEY,
  NOME_USER VARCHAR (75),
  TEL_USER CHAR (11) NOT NULL UNIQUE,
  EMAIL_USER VARCHAR (150) UNIQUE,
  SENHA_USER CHAR (64) NOT NULL,
  SECRET_USER VARCHAR(44) NOT NULL
);

DROP TABLE IF EXISTS AGENDAMENTO;
CREATE TABLE AGENDAMENTO (
  ID_AGENDAMENTO INT AUTO_INCREMENT PRIMARY KEY,
  ID_USER INT NOT NULL REFERENCES USER (ID_USER),
  DATA_CRIACAO_AGENDAMENTO TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  DATA_AGENDAMENTO DATE,
  HORARIO_AGENDAMENTO TIME
);

DROP TABLE IF EXISTS RESTRICAO;
CREATE TABLE RESTRICAO (
  ID_RESTRICAO INT AUTO_INCREMENT PRIMARY KEY,
  DIA_SEMANA INT,
  HORARIO_INICIO TIME DEFAULT '00:00',
  HORARIO_FIM TIME DEFAULT '23:59',
  DATA_INICIO DATE,
  DATA_FIM DATE
);

DROP TABLE IF EXISTS DATAS_ESPECIAIS;
CREATE TABLE DATAS_ESPECIAIS (
  ID_DATA INT AUTO_INCREMENT PRIMARY KEY,
  DATA_ESPECIAL DATE UNIQUE
);

DROP TABLE IF EXISTS SERVICOS;
CREATE TABLE SERVICOS (
  ID_SERVICO INT AUTO_INCREMENT PRIMARY KEY,
  NOME_SERVICO VARCHAR(75) NOT NULL,
  PRECO_SERVICO DECIMAL(11,2) DEFAULT 0
);

DROP TABLE IF EXISTS SERVICOS_AGENDAMENTO;
CREATE TABLE SERVICOS_AGENDAMENTO (
  ID_SERVICO INT NOT NULL REFERENCES SERVICO(ID_SERVICO),
  ID_AGENDAMENTO INT NOT NULL REFERENCES AGENDAMENTO(ID_AGENDAMENTO)
);

SELECT *
FROM RESTRICAO
INNER JOIN DATAS_ESPECIAIS ON DATA_ESPECIAL != '2023-08-06'
WHERE 
  (6 = RESTRICAO.DIA_SEMANA 
  AND (RESTRICAO.DATA_INICIO <= '2023-08-06' OR RESTRICAO.DATA_INICIO IS NULL) 
  AND ('2023-08-06' <= RESTRICAO.DATA_FIM OR RESTRICAO.DATA_FIM IS NULL))
OR 
  (RESTRICAO.DATA_INICIO <= '2023-08-06' AND ('2023-08-06' <= RESTRICAO.DATA_FIM OR RESTRICAO.DATA_FIM IS NULL));
